<div id="content-header" class="mini hidden-xs">
  <h1>Customer Information</h1>
</div><!-- end content-header -->

<div id="breadcrumb">
  <%= make_breadcrumb_link('dashboard', '/', 'Dashboard') %>
  <%= make_breadcrumb_link(@ip_range.service.icon, iprange_path(@ip_range), @ip_range.name) %>
  <%= make_breadcrumb_link('user', '', @ip_address.ip, 'current') %>
</div><!-- end breadcrumb -->

<%= render partial: 'layouts/messages' %>

<div class="container-fluid">
  <div class="row">
    <div class="col-xs-12">
      <div class="widget-box">
        <div class="widget-title">
          <span class="icon"><i class="fa fa-user"></i></span>
          <h5 id="widget-title"><%= ipaddress_widget_title(@ip_address) %></h5>
          <h5 class="pull-right hidden-xs">Subnet: <%= @ip_range.subnet_mask %> | Gateway: <%= @ip_range.gateway %></h5>
        </div>

        <div class="widget-content nopadding form-horizontal">
          <div class="form-group">
            <%= render partial: 'ipaddresses/move_modal' %>

            <%= render partial: 'ipaddresses/unassign_modal' %>

            <div class="col-sm-3">
              <a role="button" target="new" href="http://mxtoolbox.com/SuperTool.aspx?action=blacklist%3a<%="#{@ip_address.ip}"%>&run=toolpage#" class="btn btn-info btn-block">MX-Toolbox</a>
            </div>

            <div class="col-sm-3">
              <button type="button" class="btn btn-success btn-block" data-toggle="collapse" data-target="#mapContainer">Map</button>
            </div>
          </div>

          <div id="mapContainer" class="form-group collapse">
            <div class="row">
              <div class="col-xs-12">
                <div class="row">
                  <div class="col-sm-12">
                    <div class="input-group input-group-sm">
                      <%= text_field_tag 'address_map_box', encode_address(@customer), class: 'form-control input-sm' %>
                      <span class="input-group-btn">
                        <a id="encode_address" class="btn btn-inverse">Search</a>
                      </span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-12">
                    <div id='map-canvas' style='width:100%; height:500px'></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <%= form_for @customer, html: {id: 'customer_form', class: 'form-horizontal'} do |f| %>
            <%= f.hidden_field :ip_address_id, :value => @customer.ip_address.id %>
            <div class="form-group">
              <div class="row">
                <label class="col-sm-3 col-lg-2 control-label">First Name</label>
                <div class="col-sm-9 col-lg-4">
                  <%= f.text_field :first_name, class: "form-control input-sm", placeholder: 'John' %>
                </div>
                <label class="col-sm-3 col-lg-2 control-label">Last Name</label>
                <div class="col-sm-9 col-lg-4">
                  <%= f.text_field :last_name, class: "form-control input-sm", placeholder: 'Smith' %>
                </div>
              </div>
              <div class="row">
                <label class="col-sm-3 col-lg-2 control-label">Account Number</label>
                <div class="col-sm-9 col-md-9 col-lg-10">
                  <%= f.number_field :account_number, class: "form-control input-sm", placeholder: '000000000' %>
                </div>
              </div>
            </div>

            <%= f.fields_for :company do |company| %>
            <%= render partial: 'ipaddresses/company', locals: {company: company} %>
            <% end %> <!-- end company section -->

            <!-- <% @customer.build_address_book if @customer.address_book.nil? %> -->
            <%= f.fields_for :address_book do |addr| %>
            <%= render partial: 'ipaddresses/address', locals: {addr: addr} %>
            <% end %> <!-- end customer address -->

            <div class="form-group">
              <div class="row">
                <label class="col-sm-3 col-lg-2 control-label">E-Mail</label>
                <div class="col-sm-9 col-md-9 col-lg-10">
                  <%= f.email_field :email, class: "form-control input-sm", placeholder: 'jsmith@ktis.net' %>
                </div>
              </div>
            </div>

            <div class="form-group">
              <div class="row">
                <label class="col-sm-3 col-lg-2 control-label">Home Phone</label>
                <div class="col-sm-9 col-lg-2">
                  <%= f.phone_field :home_phone, class: "form-control input-sm", placeholder: 'XXX-XXX-XXXX', value: number_to_phone(@customer.home_phone, area_code: true) %>
                </div>
                <label class="col-sm-3 col-lg-2 control-label">Cell Phone</label>
                <div class="col-sm-9 col-lg-2">
                  <%= f.phone_field :cell_phone, class: "form-control input-sm", placeholder: 'XXX-XXX-XXXX', value: number_to_phone(@customer.cell_phone, area_code: true) %>
                </div>
                <label class="col-sm-3 col-lg-2 control-label">Work Phone</label>
                <div class="col-sm-9 col-lg-2">
                  <%= f.phone_field :work_phone, class: "form-control input-sm", placeholder: 'XXX-XXX-XXXX', value: number_to_phone(@customer.work_phone, area_code: true) %>
                </div>
              </div>
            </div><!-- end phone info -->

            <div class="form-group">
              <label class="col-sm-3 col-md-3 col-lg-2 control-label">Notes</label>
              <div class="col-sm-9 col-md-9 col-lg-10">
                <%= f.text_area :notes, class: "form-control" %>
              </div>
            </div><!-- end notes -->

            <div class="form-group">
              <div class="row">
                <label class="col-sm-3 col-md-2 col-md-offset-3 control-label">Modem/Router Lease</label>
                <div class="col-sm-3 col-md-2">
                  <span data-toggle="collapse" data-target="#modemLease">
                    <input type="checkbox" id="lease_checkbox" name="lease_checkbox" data-size="small" data-onstyle="success" data-offstyle="default" data-width="100" data-on="Yes" data-off="No" data-toggle="toggle"<%= ' checked' unless @customer.lease.nil? %>>
                  </span>
                </div>

                <label class="col-sm-3 col-md-2 control-label">Personal Webspace</label>
                <div class="col-sm-3 col-md-2 ">
                  <span data-toggle="collapse" data-target="#personalWebspace">
                    <input type="checkbox" id="webspace_checkbox" name="webspace_checkbox" data-size="small" data-onstyle="success" data-offstyle="default" data-width="100" data-on="Yes" data-off="No" data-toggle="toggle"<%= ' checked' unless @customer.webspace.nil? %>>
                  </span>
                </div>
              </div>
            </div><!-- end slider buttons -->

            <div class="form-group">
              <!-- <div class="row"> -->
                <div class="col-sm-3">
                  <a id="js-previous" class='btn btn-info btn-block'>Previous</a>
                </div>
                <div class="col-sm-3">
                  <%= make_tdnp_button(@customer) %>
                </div>
                <div class="col-sm-3">
                  <%= f.submit 'Save', class: 'btn btn-primary-outline btn-block' %>
                </div>
                <div class="col-sm-3">
                  <a id="js-next" class='btn btn-info btn-block'>Next</a>
                </div>
              <!-- </div> -->
            </div><!-- end form buttons -->
          </div><!-- end widget-content -->
        <% end %> <!-- end .form -->
      </div><!-- end widget-box -->
    </div><!-- end col-xs-12 -->
  </div><!-- end main customer info -->

  <%= render partial: 'ipaddresses/lease', locals: {customer: @customer} %>

  <%= render partial: 'ipaddresses/webspace', locals: {customer: @customer} %>
</div><!-- end main content -->

<% ips = IpRange.find(@customer.ip_range.id).ip_addresses.map{|ip| ip.id} %>

<script type="text/javascript" charset="utf-8">
  var firstInRange = Number("<%= ips.first %>");
  var lastInRange = Number("<%= ips.last %>");
  var currentPosition = Number("<%= @customer.ip_address.id %>")

  if (currentPosition == firstInRange) {
    console.log("First in Range");
    $("#js-previous").addClass("disabled");
  } else if (currentPosition == lastInRange) {
    console.log("Last in Range");
    $("#js-next").addClass("disabled");
  } else {
    $("#js-previous").removeClass("disabled");
    $("#js-next").removeClass("disabled");
  }

  function loadCustomerInfo(id) {
    $('html, body').animate({ scrollTop: 0 }, 'fast');

    // We need to disable the previous and next buttons if there are no more
    // available in that range.  We also need to enable the buttons when we move
    // off of those
    if (currentPosition == firstInRange) {
      console.log("First in Range");
      $("#js-previous").addClass("disabled");
    } else if (currentPosition == lastInRange) {
      console.log("Last in Range");
      $("#js-next").addClass("disabled");
    } else {
      $("#js-previous").removeClass("disabled");
      $("#js-next").removeClass("disabled");
    }


    $.get("/api/v1/ipaddresses/" + id, function(data) {
      $(".current").replaceWith("<a class=\"current\"><i class=\"fa fa-user\"></i> " + data["ip"] + "</a>");

      if (data["customer"] == null) {
        $("#moveBtn").addClass("disabled");
        $("#unassignBtn").addClass("disabled");
        $("#moveBtn").attr("disabled");
        $("#unassignBtn").attr("disabled");

        $("#customer_first_name").val("");
        $("#customer_last_name").val("");
        $("#customer_account_number").val("");

        $("#customer_address_book_attributes_address_1").val("");
        $("#customer_address_book_attributes_address_2").val("");
        $("#customer_address_book_attributes_city").val("");
        $("#customer_address_book_attributes_state").val("");
        $("#customer_address_book_attributes_zipcode").val("");
        $("#customer_email").val("");
        $("#customer_home_phone").val("");
        $("#customer_cell_phone").val("");
        $("#custmer_work_phone").val("");

        $("#customer_company_attributes_name").val("");
        $("#customer_company_attributes_contact_first_name").val("");
        $("#customer_company_attributes_contact_last_name").val("");
        $("#customer_company_attributes_contact_email").val("");
        $("#customer_company_attributes_billing_email").val("");
        $("#customer_company_attributes_company_address_attributes_address_1").val("");
        $("#customer_company_attributes_company_address_attributes_address_2").val("");
        $("#customer_company_attributes_company_address_attributes_city").val("");
        $("#customer_company_attributes_company_address_attributes_state").val("");
        $("#customer_company_attributes_company_address_attributes_zipcode").val("");
        $("#customer_company_attributes_company_address_attributes_main_number").val("");
        $("#customer_company_attributes_company_address_attributes_contact_number").val("");
        $("#customer_company_attributes_company_address_attributes_fax").val("");
        $("#customer_notes").val("");


        $("#widget-title").text("-");

        $("#tdnpButton").replaceWith("<button id=\"tdnpButton\" class=\"btn btn-block btn-secondary disabled\">Disconnect</button>");
      } else {
        class googleMapsAddress {
          constructor(address1, address2, city, state, zipcode) {
            this.address1 = address1;
            this.address2 = address2;
            this.city = city;
            this.state = state;
            this.zipcode = zipcode;
          }

          encodeForGoogleMaps() {
            return this.address1 + " " + this.address2 + ", " + this.city + ", " + this.state + ", " + this.zipcode;
          }
        }

        var customerId = data["customer"]["id"];
        var customer = data["customer"];

        $("#moveBtn").removeClass("disabled");
        $("#unassignBtn").removeClass("disabled");
        $("#moveBtn").removeAttr("disabled");
        $("#unassignBtn").removeAttr("disabled");

        $("#customer_ip_address").val(data["ip"]);
        $("#customer_first_name").val(customer.first_name);
        $("#customer_last_name").val(customer.last_name);
        $("#customer_account_number").val(customer.account_number);

        $("#customer_address_book_attributes_address_1").val(customer.address_book.address_1);
        $("#customer_address_book_attributes_address_2").val(customer.address_book.address_2);
        $("#customer_address_book_attributes_city").val(customer.address_book.city);
        $("#customer_address_book_attributes_state").val(customer.address_book.state);
        $("#customer_address_book_attributes_zipcode").val(customer.address_book.zipcode);

        var customerAddress = new googleMapsAddress(customer.address_book.address_1, customer.address_book.address_2, customer.address_book.city, customer.address_book.state, customer.address_book.zipcode);
        $("#address_map_box").val(customerAddress.encodeForGoogleMaps());
        $("#encode_address").trigger("click");

        if (customer.company == null) {
          $("#customer_company_attributes_name").val("");
          $("#customer_company_attributes_contact_first_name").val("");
          $("#customer_company_attributes_contact_last_name").val("");
          $("#customer_company_attributes_contact_email").val("");
          $("#customer_company_attributes_billing_email").val("");
          $("#customer_company_attributes_company_address_attributes_address_1").val("");
          $("#customer_company_attributes_company_address_attributes_address_2").val("");
          $("#customer_company_attributes_company_address_attributes_city").val("");
          $("#customer_company_attributes_company_address_attributes_state").val("");
          $("#customer_company_attributes_company_address_attributes_zipcode").val("");
          $("#customer_company_attributes_company_address_attributes_main_number").val("");
          $("#customer_company_attributes_company_address_attributes_contact_number").val("");
          $("#customer_company_attributes_company_address_attributes_fax").val("");
        } else {
          $("#customer_company_attributes_name").val(customer.company.name);
          $("#customer_company_attributes_contact_first_name").val(customer.company.contact_first_name);
          $("#customer_company_attributes_contact_last_name").val(customer.company.contact_last_name);
          $("#customer_company_attributes_contact_email").val(customer.company.contact_email);
          $("#customer_company_attributes_billing_email").val(customer.company.billing_email);
          $("#customer_company_attributes_company_address_attributes_address_1").val(customer.company.address_1);
          $("#customer_company_attributes_company_address_attributes_address_2").val(customer.company.address_2);
          $("#customer_company_attributes_company_address_attributes_city").val(customer.company.city);
          $("#customer_company_attributes_company_address_attributes_state").val(customer.company.state);
          $("#customer_company_attributes_company_address_attributes_zipcode").val(customer.company.zipcode);
          $("#customer_company_attributes_company_address_attributes_main_number").val(customer.company.main_number.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'));

          if (customer.company.contact_number != null) {
            $("#customer_company_attributes_company_address_attributes_contact_number").val(customer.company.contact_number.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'));
          }

          if (customer.company.fax != null) {
            $("#customer_company_attributes_company_address_attributes_fax").val(customer.company.fax.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'));
          }

        }

        $("#customer_email").val(customer.email);
        $("#customer_home_phone").val(customer.home_phone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'));

        if (data["customer"]["cell_phone"] != null) {
          $("#customer_cell_phone").val(customer.cell_phone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'));
        }

        if (data["customer"]["work_phone"] != null) {
          $("#custmer_work_phone").val(customer.work_phone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'));
        }

        $("#customer_notes").val(customer.notes);

        $("#widget-title").text(customer.name);

        if (data["customer"]["active"] == true) {
          $("#tdnpButton").replaceWith("<a id=\"tdnpButton\" class=\"btn btn-danger btn-block TDNP\" href=\"/customers/" + data["id"] + "/tdnp\">Disconnect</a>");
        } else {
          $("#tdnpButton").replaceWith("<a id=\"tdnpButton\" class=\"btn btn-success btn-block TDNP\" href=\"/customers/" + data["id"] + "/tdnp\">Reconnect</a>");
        }
      }

      var moveLink = "/customers/" + data["id"] + "/move";
      $("moveConfirmBtn").prop("href", moveLink);
      var unassignLink = "/customers/" + data["id"] + "/unassign";
      $("unassignConfirmBtn").prop("href", unassignLink);
    });
  }

  // Navagation through the addresses in the IP Range
  $("#js-previous").on("click", function(id) {
    loadCustomerInfo(currentPosition -= 1);
  });

  $("#js-next").on("click", function() {
    loadCustomerInfo(currentPosition += 1);
  });

  // Form Submitting Stuff
  $('form').submit(function() {
    var data_submitted = $(this).serialize();
    $.ajax({
      url: $(this).attr('action'),
      data: $(this).serialize(),
      type: "POST",
      success: function(response) {

      },
      error: function(xhr, textStatus, errorThrown) {

      }
    });

    $('#widget-title').text($("#customer_first_name").val() + " " + $("#customer_last_name").val());

    $('html, body').animate({ scrollTop: 0 }, 'fast');

    return false; // prevents normal behaviour
  });
</script>
